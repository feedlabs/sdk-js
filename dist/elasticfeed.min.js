/*! elasticfeed v0.0.1 10-02-2015 */
var Channel=function(){function a(a){this.id=g(),this.url=null,e.url=e.transport+"://"+e.host+":"+e.port+e.path_ws,this.options=f(e,a),null!==this.options.id&&(this.id=this.options.id),null!==this.options.url&&(this.url=this.options.url),this._handlers={},this._socket=null,this._xhr=[]}const b=0,c=1,d=2;var e={id:null,transport:"ws",connectOnInit:!0,host:"localhost",port:"10100",path_ws:"/stream/ws",path_lp:"/stream/lp",path_sse:"/stream/sse"};a.prototype.on=function(a,e){switch(a){case"join":type=b;break;case"leave":type=c;break;case"message":type=d;break;default:return!1}return void 0===this._handlers[type]&&(this._handlers[type]=[]),this._handlers[type].push(e),!0},a.prototype.onData=function(a){switch(a.type){case b:this.onJoin(a.user,a.ts);break;case c:this.onLeave(a.user,a.ts);break;case d:this.onMessage(a.user,a.ts,a.content)}},a.prototype.onJoin=function(a,c){for(var d in this._handlers[b])this._handlers[b][d].call(this,a,c)},a.prototype.onLeave=function(a,b){for(var d in this._handlers[c])this._handlers[c][d].call(this,a,b)},a.prototype.onMessage=function(a,b,c){systemEvent=new Event(c);for(var e in this._handlers[d])this._handlers[d][e].call(this,a,b,systemEvent)},a.prototype.isWebSocket=function(){return void 0!==this._socket},a.prototype.getConnection=function(){},a.prototype.getWebSocketConnection=function(){var a=this;return null===this._socket&&(this._socket=new WebSocket(this.url+"/join?chid="+this.id),this._socket.onmessage=function(b){b=new Event(JSON.parse(b.data)),a.onData(b)}),{send:function(b){a._socket.send(JSON.stringify(b))}}},a.prototype.getLongPoolingConnection=function(){if(self=this,null===this._socket){var a=0,b=!1;this.getJSON(this.url+"/join?chid="+this.id,function(a){null!==a&&(event=new Event(a.response),self.onData(event))});var c=function(){b||(b=!0,self.getJSON(self.url+"/fetch?lastReceived="+a,function(c,d){4==d&&(b=!1),null!==c&&(self.each(c,function(b,c){c=new Event(c),self.onData(c),a=c.GetTimestamp()}),b=!1)}))};this._socket=setInterval(c,3e3),c()}return{send:function(a){self.post(self.url+"/post",{chid:self.id,data:JSON.stringify(a)},function(a){response_json=JSON.parse(a),event=new Event(JSON.parse(response_json.response)),self.onData(event)})}}},a.prototype.getSSEConnection=function(){return es=new EventSource(this.url+"/join"),es.onmessage=function(){},es.addEventListener("some-event",function(){},!1),{send:function(a){self.post(this.url+"/post",{chid:self.id,data:JSON.stringify(a)},function(a){response_json=JSON.parse(a),event=new Event(JSON.parse(response_json.response)),self.onData(event)})}}},a.prototype.__cleanup=function(){for(var a in this._xhr)4==this._xhr[a].xhr.readyState&&delete this._xhr[a]},a.prototype.getJSON=function(a,b){this.__cleanup();var c=this._xhr.length;this._xhr[c]={xhr:new XMLHttpRequest,cb:b};var d=this;this._xhr[c].xhr.onreadystatechange=function(){4==d._xhr[c].xhr.readyState&&200==d._xhr[c].xhr.status&&""!==d._xhr[c].xhr.responseText?(data=JSON.parse(d._xhr[c].xhr.responseText),d._xhr[c].cb.call(this,data,d._xhr[c].xhr.readyState)):d._xhr[c].cb.call(this,null,d._xhr[c].xhr.readyState)},this._xhr[c].xhr.open("GET",a,!0),this._xhr[c].xhr.send("")},a.prototype.each=function(a,b){for(i=0;i<a.length&&(value=b.call(a[i],i,a[i]),value!==!1);i++);},a.prototype.queryString=function(a){return Object.keys(a).map(function(b){return encodeURIComponent(b)+"="+encodeURIComponent(a[b])}).join("&")},a.prototype.post=function(a,b,c){this.__cleanup();var d=this._xhr.length;this._xhr[d]={xhr:new XMLHttpRequest,cb:c};var e=this;this._xhr[d].xhr.onreadystatechange=function(){4==e._xhr[d].xhr.readyState&&200==e._xhr[d].xhr.status&&e._xhr[d].cb.call(this,e._xhr[d].xhr.responseText)},dataString=this.queryString(b),this._xhr[d].xhr.open("POST",a+"?"+dataString,!0),this._xhr[d].xhr.send(dataString)};var f=function(a,b){var c,d={};for(c in a)a.hasOwnProperty(c)&&(d[c]=a[c]);for(c in b)b.hasOwnProperty(c)&&(d[c]=b[c]);return d},g=function(){return"_"+Math.random().toString(36).substr(2,36)};return a}();!function(a){var b={channel:{url:"localhost",transport:"ws"}},c={options:{},channelList:{},feedList:{},init:function(a){this.options=d(b,a)},initFeed:function(a,b){return void 0===a?!1:(void 0===this.feedList[a]&&(opts=d(this.options,b||{}),channel=this.getChannel(opts.channel),this.feedList[a]=new Feed(a,opts,channel)),this.feedList[a])},getChannel:function(a,b){return void 0===a.url?!1:(void 0===this.channelList[a.url]&&(this.channelList[a.url]=new Channel(a,b)),this.channelList[a.url])},findFeed:function(a){return void 0===this.feedList[a]?!1:this.feedList[a]},findChannel:function(a){return void 0===this.channelList[a]?!1:this.channelList[a]}},d=function(a,b){var c,d={};for(c in a)a.hasOwnProperty(c)&&(d[c]=a[c]);for(c in b)b.hasOwnProperty(c)&&(d[c]=b[c]);return d};"function"==typeof define?define(function(){return c}):a.elasticfeed=c}(window),Element.prototype.remove=function(){this.parentElement.removeChild(this)},NodeList.prototype.remove=HTMLCollection.prototype.remove=function(){for(var a=0,b=this.length;b>a;a++)this[a]&&this[a].parentElement&&this[a].parentElement.removeChild(this[a])};var Entry=function(){function a(a,b){this.id=null,this.viewId=f(),this.data=a,this._feed=null,this._styler=(b?b.styler:void 0)||function(){return a},this._handlers={},void 0!==this.data.Id&&(this.id=this.data.Id)}const b=1,c=2,d=3,e=4;a.prototype.setParent=function(a){this._feed=a,this.bindMessages()},a.prototype.getViewId=function(){return this.viewId},a.prototype.render=function(){try{document.getElementById(this.viewId).innerHTML=this._styler.call(this,this.data.Id+"<br>"+this.data.Data)}catch(a){}},a.prototype.on=function(a,f){switch(name){case"delete":a=c;break;case"update":a=b;break;case"hide":a=d;break;case"show":a=e;break;default:return!1}return void 0===this._handlers[a]&&(this._handlers[a]=[]),this._handlers[a].push(f),!0},a.prototype.onData=function(a){switch(a.type){case c:this.onDelete(a.ts);break;case b:this.onUpdate(a.ts,a.content);break;case d:this.onHide(a.ts);break;case e:this.onShow(a.ts)}},a.prototype.update=function(a,b){this.data=b,this.render()},a.prototype["delete"]=function(){this.unbindMessages(),document.getElementById(this.viewId).remove()},a.prototype.hide=function(){},a.prototype.show=function(){},a.prototype.apiEntryUpdate=function(){},a.prototype.apiMetricSave=function(){},a.prototype.onUpdate=function(a,c){this.update(a,c);for(var d in this._handlers[b])this._handlers[b][d].call(this,a,c)},a.prototype.onDelete=function(a){for(var b in this._handlers[c])this._handlers[c][b].call(this,a)},a.prototype.onHide=function(a){for(var b in this._handlers[d])this._handlers[d][b].call(this,a)},a.prototype.onShow=function(a){for(var b in this._handlers[e])this._handlers[e][b].call(this,a)},a.prototype.bindMessages=function(){var a=this;this.__bindFeed=this._feed.on("entry-message",function(b,c){null===a.id||c.user!=a.id&&"*"!=c.user||a.onData(c)})},a.prototype.unbindMessages=function(){this._feed.off(this.__bindFeed)},a.prototype.getTimestamp=function(){return this.ts};var f=function(){return"_"+Math.random().toString(36).substr(2,36)};return a}(),Event=function(){function a(a){this.id=a.Id||null,this.ts=a.Timestamp,this.actionGroup=null,this.actionType=null,this.user=a.User,this.type=a.Type,this.contentType="string";try{this.content=JSON.parse(a.Content),this.contentType="json"}catch(b){this.content=a.Content}}return a.prototype.GetTimestamp=function(){return this.ts},a.prototype.PrintContent=function(){return"string"==this.contentType?this.content:JSON.stringify(this.content)},a}(),Feed=function(){function a(a,b,c){this.id=a,this.feedId=a.split(/[::]/)[0],this.appId=a.split(/[::]/)[1],this.orgId=a.split(/[::]/)[2],this.channel=c,this.entryList=[],this.loadInit(),"ws"==this.channel.options.transport?this.socket=this.channel.getWebSocketConnection():"lp"==this.channel.options.transport&&(this.socket=this.channel.getLongPoolingConnection()),this.options=p(o,b),this.stylerFunction=this.options.stylerFunction,this.renderFunction=this.options.renderFunction,this.outputContainer=document.getElementById(this.options.outputContainerId),this.bindChannel(this.channel),this._handlers={},this._state={initiated:!1}}const b=1,c=1,d=2,e=3,f=4,g=5,h=6,i=7,j=8,k=100,l=101,m=102,n=103;var o={stylerFunction:function(a){return JSON.stringify(a)},renderFunction:function(a){return JSON.stringify(a)}};a.prototype.on=function(a,b){switch(a){case"reload":type=c;break;case"empty":type=d;break;case"entry":type=e;break;case"entry-init":type=f;break;case"entry-more":type=g;break;case"hide":type=h;break;case"show":type=i;break;case"entry-message":type=j;break;case"authenticated":type=k;break;case"authentication-required":type=l;break;case"authentication-failed":type=m;break;case"logout":type=n;break;default:return!1}return void 0===this._handlers[type]&&(this._handlers[type]=[]),this._handlers[type].push(b),b},a.prototype.off=function(a){for(var b in this._handlers)for(var c in this._handlers[b])if(this._handlers[b][c]==a)return void delete this._handlers[b][c]},a.prototype.onData=function(a){switch(a.type){case c:this.onReload(a.ts);break;case d:this.onEmpty(a.ts);break;case e:this.onEntryNew(a.ts,a.content);break;case f:this.onEntryInit(a.ts,a.content);break;case g:this.onEntryMore(a.ts,a.content);break;case h:this.onHide(a.ts);break;case i:this.onShow(a.ts);break;case j:this.onEntryMessage(a.ts,a.content);break;case k:this.onAuthenticated(a.ts,a.content);break;case l:this.onAuthenticationRequired(a.ts,a.content);break;case m:this.onAuthenticationFailed(a.ts,a.content);break;case n:this.onLogout(a.ts,a.content)}},a.prototype.onReload=function(a){for(var b in this._handlers[c])this._handlers[c][b].call(this,a)},a.prototype.onEmpty=function(a){for(var b in this._handlers[d])this._handlers[d][b].call(this,a)},a.prototype.onEntryNew=function(a,b){entry=new Entry(b,{styler:this.stylerFunction}),this.addEntry(entry);for(var c in this._handlers[e])this._handlers[e][c].call(this,a,entry)},a.prototype.onEntryInit=function(a,b){for(var c in b)this.onEntryNew(a,b[c]);for(var c in this._handlers[f])this._handlers[f][c].call(this,a,b)},a.prototype.onEntryMore=function(a,b){entries=JSON.parse(b);for(var c in this._handlers[g])this._handlers[g][c].call(this,a,entries)},a.prototype.onHide=function(a){for(var b in this._handlers[h])this._handlers[h][b].call(this,a)},a.prototype.onShow=function(a){for(var b in this._handlers[i])this._handlers[i][b].call(this,a)},a.prototype.onEntryMessage=function(a,b){entryEvent=new Event(b);for(var c in this._handlers[j])this._handlers[j][c].call(this,a,entryEvent)},a.prototype.onAuthenticated=function(a){for(var b in this._handlers[k])this._handlers[k][b].call(this,a)},a.prototype.onAuthenticationRequired=function(a){for(var b in this._handlers[l])this._handlers[l][b].call(this,a)},a.prototype.onAuthenticationFailed=function(a){for(var b in this._handlers[m])this._handlers[m][b].call(this,a)},a.prototype.onLogout=function(a){for(var b in this._handlers[n])this._handlers[n][b].call(this,a)},a.prototype.reload=function(){this.empty(),this.socket.send({action:f,feedId:this.feedId,appId:this.appId,orgId:this.orgId})},a.prototype.loadMore=function(){this.socket.send({action:g,feedId:this.feedId,appId:this.appId,orgId:this.orgId,state:{}})},a.prototype.loadInit=function(){var a=this;this.channel.on("join",function(){a._state.initiated!==!0&&(a.socket.send({action:f,feedId:a.feedId,appId:a.appId,orgId:a.orgId}),a._state.initiated=!0)})},a.prototype.addEntry=function(a){a.setParent(this),this.entryList.push(a),this.outputContainer.innerHTML='<div id="'+a.getViewId()+'"></div>'+this.outputContainer.innerHTML,a.render()},a.prototype.deleteEntry=function(a){a["delete"]()},a.prototype.updateEntry=function(){},a.prototype.empty=function(){for(var a in this.entryList)this.deleteEntry(this.entryList[a]),delete this.entryList[a];this.entryList=[]},a.prototype.findEntry=function(){},a.prototype.render=function(){for(var a in this.entryList)this.entryList[a].render()},a.prototype.bindChannel=function(a){var c=this;a.on("message",function(a,d,e){e.type==b&&(feedEvent=new Event(e.content),(feedEvent.user==c.feedId||"*"==feedEvent.user)&&c.onData(feedEvent))})};var p=function(a,b){var c,d={};for(c in a)a.hasOwnProperty(c)&&(d[c]=a[c]);for(c in b)b.hasOwnProperty(c)&&(d[c]=b[c]);return d};return a}();